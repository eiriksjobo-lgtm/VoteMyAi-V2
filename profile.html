<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KW4NR9QBWB"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-KW4NR9QBWB');</script>
  <title>My Profile – VoteMyAI</title>
  <meta name="description" content="Manage your VoteMyAI profile – view your submitted tracks and ratings.">
  <meta property="og:title" content="My Profile – VoteMyAI">
  <meta property="og:site_name" content="VoteMyAI">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #07070b; --surface: #0e0e14; --surface-2: #131319;
      --border: #1a1a26; --border-hover: #252535;
      --accent: #e8ff47; --accent-dim: rgba(232,255,71,0.12);
      --text: #f2f2f4; --text-secondary: #a8a8b8; --muted: #5c5c72;
      --danger: #f87171; --danger-dim: rgba(248,113,113,0.1);
      --radius: 14px; --radius-sm: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; line-height: 1.6; -webkit-font-smoothing: antialiased; }
    ::selection { background: var(--accent); color: var(--bg); }

    /* Nav */
    nav {
      position: sticky; top: 0; z-index: 200;
      background: rgba(7,7,11,0.88); backdrop-filter: blur(24px) saturate(1.4);
      border-bottom: 1px solid rgba(26,26,38,0.6);
      height: 60px; display: flex; align-items: center; justify-content: space-between;
      padding: 0 clamp(16px, 4vw, 40px);
    }
    .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 3px; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .logo-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .nav-right { display: flex; align-items: center; gap: 8px; }
    .nav-link { color: var(--muted); text-decoration: none; font-size: 0.72rem; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; padding: 8px 14px; border-radius: 8px; transition: all 0.2s; }
    .nav-link:hover { color: var(--text); background: rgba(255,255,255,0.04); }
    .btn-submit { background: var(--accent); color: var(--bg); padding: 8px 18px; border-radius: var(--radius-sm); border: none; font-weight: 700; cursor: pointer; font-size: 0.72rem; letter-spacing: 1.2px; text-transform: uppercase; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
    .btn-submit:hover { box-shadow: 0 4px 20px rgba(232,255,71,0.25); transform: translateY(-1px); }

    /* Container */
    .container { max-width: 800px; margin: 0 auto; padding: 48px clamp(16px, 4vw, 40px) 80px; }

    /* Profile Card */
    .profile-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 32px; margin-bottom: 32px; position: relative;
    }
    .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; }
    .avatar {
      width: 72px; height: 72px; border-radius: 50%; background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6rem; font-weight: 700; color: var(--bg); overflow: hidden; flex-shrink: 0;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 1px; line-height: 1.1; }
    .profile-email { color: var(--muted); font-size: 0.82rem; margin-top: 2px; }

    /* Edit name */
    .name-edit { display: flex; align-items: center; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .name-input {
      flex: 1; background: var(--surface-2); border: 1px solid var(--border); color: var(--text);
      padding: 10px 14px; border-radius: var(--radius-sm); font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem; outline: none; transition: border-color 0.2s;
    }
    .name-input:focus { border-color: var(--accent); }
    .btn-save {
      background: var(--accent); color: var(--bg); border: none; padding: 10px 20px;
      border-radius: var(--radius-sm); font-weight: 700; font-size: 0.75rem;
      letter-spacing: 0.8px; text-transform: uppercase; cursor: pointer;
      font-family: 'DM Sans', sans-serif; transition: all 0.2s; white-space: nowrap;
    }
    .btn-save:hover { box-shadow: 0 4px 16px rgba(232,255,71,0.25); }
    .btn-save:disabled { opacity: 0.5; cursor: default; box-shadow: none; }
    .save-status { font-size: 0.75rem; color: var(--accent); margin-top: 8px; min-height: 20px; }

    /* Stats */
    .stats-row { display: flex; gap: 16px; margin-bottom: 32px; }
    .stat-card {
      flex: 1; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; text-align: center;
    }
    .stat-num { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--accent); line-height: 1; }
    .stat-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; margin-top: 4px; }

    /* Section */
    .section-title {
      font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem;
      letter-spacing: 1.5px; margin: 32px 0 16px; color: var(--text-secondary);
    }

    /* Track list */
    .tracks-list { display: flex; flex-direction: column; gap: 10px; }
    .track-item {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px; display: flex; gap: 16px; align-items: center; transition: border-color 0.2s;
    }
    .track-item:hover { border-color: var(--border-hover); }
    .track-thumb { width: 80px; height: 52px; border-radius: 6px; overflow: hidden; flex-shrink: 0; background: var(--surface-2); }
    .track-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .track-details { flex: 1; min-width: 0; }
    .track-title { font-size: 0.88rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-meta { color: var(--muted); font-size: 0.75rem; margin-top: 2px; }
    .track-rating { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
    .track-rating-score { font-weight: 700; color: var(--accent); font-size: 0.9rem; }
    .track-rating-count { color: var(--muted); font-size: 0.7rem; }
    .btn-delete {
      background: var(--danger-dim); border: 1px solid rgba(248,113,113,0.3);
      color: var(--danger); padding: 6px 12px; border-radius: 6px; cursor: pointer;
      font-size: 0.7rem; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
      font-family: 'DM Sans', sans-serif; transition: all 0.2s; flex-shrink: 0;
    }
    .btn-delete:hover { background: rgba(248,113,113,0.2); }

    /* Rated tracks */
    .rated-star { color: var(--accent); font-size: 0.85rem; }

    /* Logout */
    .btn-logout {
      background: var(--danger-dim); border: 1px solid rgba(248,113,113,0.3);
      color: var(--danger); padding: 10px 24px; border-radius: var(--radius-sm);
      cursor: pointer; font-size: 0.75rem; font-weight: 700; letter-spacing: 1px;
      text-transform: uppercase; font-family: 'DM Sans', sans-serif;
      margin-top: 40px; display: inline-block; transition: all 0.2s;
    }
    .btn-logout:hover { background: rgba(248,113,113,0.2); }

    /* Empty state */
    .empty { color: var(--muted); font-size: 0.85rem; padding: 32px; text-align: center; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
    .empty a { color: var(--accent); text-decoration: none; }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, var(--surface-2) 25%, rgba(255,255,255,0.03) 50%, var(--surface-2) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius); }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skel-track { height: 68px; margin-bottom: 10px; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 1px solid rgba(232,255,71,0.2);
      color: var(--text); padding: 12px 24px; border-radius: var(--radius-sm);
      font-size: 0.82rem; z-index: 9999; opacity: 0; transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }

    @media (max-width: 640px) {
      .container { padding: 32px 12px 60px; }
      .profile-header { gap: 14px; }
      .avatar { width: 56px; height: 56px; font-size: 1.2rem; }
      .profile-name { font-size: 1.4rem; }
      .stats-row { gap: 8px; }
      .stat-card { padding: 14px; }
      .stat-num { font-size: 1.5rem; }
      .track-item { padding: 12px; gap: 10px; }
      .track-thumb { width: 64px; height: 42px; }
      .track-title { font-size: 0.82rem; }
      .btn-delete { padding: 5px 10px; font-size: 0.62rem; }
    }
  </style>
</head>
<body>

<nav>
  <a href="/" class="logo"><span class="logo-dot"></span>VOTEMYAI</a>
  <div class="nav-right">
    <a href="/" class="nav-link">Home</a>
    <a href="/blog.html" class="nav-link">Blog</a>
    <button class="btn-submit" onclick="window.location.href='/submit.html'">Submit</button>
  </div>
</nav>

<div class="container">
  <!-- Profile Card -->
  <div class="profile-card">
    <div class="profile-header">
      <div class="avatar" id="avatar">?</div>
      <div>
        <div class="profile-name" id="userName">Loading...</div>
        <div class="profile-email" id="userEmail"></div>
      </div>
    </div>
    <div class="name-edit">
      <input type="text" class="name-input" id="nameInput" placeholder="Choose a display name..." maxlength="30">
      <button class="btn-save" id="btnSave" onclick="saveName()">Save</button>
    </div>
    <div class="save-status" id="saveStatus"></div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card"><div class="stat-num" id="statTracks">—</div><div class="stat-label">Tracks</div></div>
    <div class="stat-card"><div class="stat-num" id="statAvgRating">—</div><div class="stat-label">Avg Rating</div></div>
    <div class="stat-card"><div class="stat-num" id="statTotalRatings">—</div><div class="stat-label">Ratings Received</div></div>
  </div>

  <!-- My Tracks -->
  <div class="section-title">My Tracks</div>
  <div class="tracks-list" id="tracksList">
    <div class="skeleton skel-track"></div>
    <div class="skeleton skel-track"></div>
  </div>

  <!-- My Ratings -->
  <div class="section-title">My Ratings</div>
  <div class="tracks-list" id="ratingsList">
    <div class="skeleton skel-track"></div>
    <div class="skeleton skel-track"></div>
  </div>

  <!-- Logout -->
  <button class="btn-logout" onclick="logout()">Log Out</button>
</div>

<div class="toast" id="toast"></div>

<script>
  const SUPABASE_URL = 'https://gezijezmsecbtzytotax.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_hOOMtCz7gYsu_-CVD6lW9Q_SxtFlNhw';
  let token = localStorage.getItem('sb_token');
  let currentUser = null;

  function sanitize(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  function getThumbUrl(track) {
    if (track.thumbnail_url) return track.thumbnail_url;
    if (track.yt_id) return `https://img.youtube.com/vi/${track.yt_id}/mqdefault.jpg`;
    return '';
  }

  // ─── Init ───
  async function init() {
    if (!token) { window.location.href = '/login.html'; return; }

    // Auth
    const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      headers: { 'Authorization': `Bearer ${token}`, 'apikey': SUPABASE_KEY }
    });
    if (!res.ok) { localStorage.removeItem('sb_token'); window.location.href = '/login.html'; return; }
    currentUser = await res.json();

    // Profile info
    const displayName = currentUser.user_metadata?.display_name || currentUser.user_metadata?.name || currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('nameInput').value = currentUser.user_metadata?.display_name || '';
    document.getElementById('nameInput').placeholder = displayName;

    // Avatar
    const avatarEl = document.getElementById('avatar');
    const avatarUrl = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
    if (avatarUrl) { avatarEl.innerHTML = `<img src="${sanitize(avatarUrl)}" alt="${sanitize(displayName)}">`; }
    else { avatarEl.textContent = displayName.charAt(0).toUpperCase(); }

    // Load data
    await Promise.all([loadMyTracks(), loadMyRatings()]);
  }

  // ─── Save Display Name ───
  async function saveName() {
    const nameInput = document.getElementById('nameInput');
    const newName = nameInput.value.trim();
    if (!newName) { showToast('Name cannot be empty'); return; }
    if (newName.length > 30) { showToast('Max 30 characters'); return; }

    const btn = document.getElementById('btnSave');
    btn.disabled = true; btn.textContent = '...';

    try {
      const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: { display_name: newName } })
      });
      if (res.ok) {
        document.getElementById('userName').textContent = newName;
        document.getElementById('saveStatus').textContent = 'Name updated!';
        setTimeout(() => { document.getElementById('saveStatus').textContent = ''; }, 2000);
      } else {
        showToast('Could not update name');
      }
    } catch(e) { showToast('Network error'); }

    btn.disabled = false; btn.textContent = 'Save';
  }

  // ─── My Tracks ───
  async function loadMyTracks() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/tracks?user_id=eq.${currentUser.id}&select=*&order=created_at.desc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${token}` }
      });
      const tracks = await res.json();

      // Stats
      document.getElementById('statTracks').textContent = tracks.length;
      const rated = tracks.filter(t => t.rating_count > 0);
      const totalRatings = tracks.reduce((s, t) => s + (t.rating_count || 0), 0);
      document.getElementById('statTotalRatings').textContent = totalRatings;
      if (rated.length > 0) {
        const avgAll = rated.reduce((s, t) => s + (t.avg_rating || 0), 0) / rated.length;
        document.getElementById('statAvgRating').textContent = avgAll.toFixed(1);
      } else {
        document.getElementById('statAvgRating').textContent = '—';
      }

      // Render
      const list = document.getElementById('tracksList');
      if (!tracks.length) {
        list.innerHTML = '<div class="empty">No tracks yet. <a href="/submit.html">Submit your first track!</a></div>';
        return;
      }
      list.innerHTML = tracks.map(t => {
        const thumb = getThumbUrl(t);
        const avg = t.avg_rating ? parseFloat(t.avg_rating).toFixed(1) : '—';
        return `<div class="track-item">
          ${thumb ? `<div class="track-thumb"><img src="${sanitize(thumb)}" alt="${sanitize(t.title)}" loading="lazy"></div>` : ''}
          <div class="track-details">
            <div class="track-title">${sanitize(t.title)}</div>
            <div class="track-meta">${sanitize(t.tool)} · ${sanitize(t.genre)} · ${t.rating_count || 0} ratings</div>
          </div>
          <div class="track-rating">
            <span class="track-rating-score">${avg}</span>
            <span class="track-rating-count">avg</span>
          </div>
          <button class="btn-delete" onclick="deleteTrack('${t.id}')">Delete</button>
        </div>`;
      }).join('');
    } catch(e) { document.getElementById('tracksList').innerHTML = '<div class="empty">Could not load tracks</div>'; }
  }

  // ─── My Ratings ───
  async function loadMyRatings() {
    const anonToken = localStorage.getItem('votemyai_anon_token');
    if (!anonToken) { document.getElementById('ratingsList').innerHTML = '<div class="empty">No ratings yet</div>'; return; }

    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/anonymous_ratings?anon_token=eq.${anonToken}&select=track_id,score`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const ratings = await res.json();
      if (!ratings.length) { document.getElementById('ratingsList').innerHTML = '<div class="empty">No ratings yet — go rate some tracks!</div>'; return; }

      // Fetch track details
      const trackIds = ratings.map(r => r.track_id);
      const tracksRes = await fetch(`${SUPABASE_URL}/rest/v1/tracks?id=in.(${trackIds.join(',')})&select=id,title,tool,genre,thumbnail_url,yt_id`, {
        headers: { 'apikey': SUPABASE_KEY }
      });
      const tracks = await tracksRes.json();
      const trackMap = {};
      tracks.forEach(t => { trackMap[t.id] = t; });

      const list = document.getElementById('ratingsList');
      list.innerHTML = ratings.map(r => {
        const t = trackMap[r.track_id];
        if (!t) return '';
        const thumb = getThumbUrl(t);
        const stars = '★'.repeat(r.score) + '☆'.repeat(5 - r.score);
        return `<div class="track-item">
          ${thumb ? `<div class="track-thumb"><img src="${sanitize(thumb)}" alt="${sanitize(t.title)}" loading="lazy"></div>` : ''}
          <div class="track-details">
            <div class="track-title">${sanitize(t.title)}</div>
            <div class="track-meta">${sanitize(t.tool)} · ${sanitize(t.genre)}</div>
          </div>
          <div class="rated-star">${stars}</div>
        </div>`;
      }).filter(Boolean).join('');
      if (!list.innerHTML) list.innerHTML = '<div class="empty">No ratings yet</div>';
    } catch(e) { document.getElementById('ratingsList').innerHTML = '<div class="empty">Could not load ratings</div>'; }
  }

  // ─── Delete Track ───
  window.deleteTrack = async (id) => {
    if (!confirm('Delete this track? This cannot be undone.')) return;
    try {
      await fetch(`${SUPABASE_URL}/rest/v1/tracks?id=eq.${id}`, {
        method: 'DELETE',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${token}` }
      });
      showToast('Track deleted');
      await loadMyTracks();
    } catch(e) { showToast('Could not delete track'); }
  };

  window.logout = () => {
    localStorage.removeItem('sb_token');
    window.location.href = '/';
  };

  window.saveName = saveName;
  init();
</script>
</body>
</html>
