<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KW4NR9QBWB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KW4NR9QBWB');
  </script>
  
  <title>Submit Your AI Music Track – VoteMyAI</title>
  
  <meta name="description" content="Submit your AI-generated music track to VoteMyAI. Share songs made with Suno, Udio or other AI tools via YouTube, SoundCloud or directly and let the community rate.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.votemyai.com/submit.html">
  <meta name="theme-color" content="#e8ff47">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --border: #1e1e2e;
      --accent: #e8ff47;
      --text: #f0f0f0;
      --muted: #666680;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container { max-width: 600px; margin: 0 auto; }
    
    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.5rem;
      letter-spacing: 2px;
      color: var(--accent);
      margin-bottom: 32px;
      text-align: center;
    }
    
    .form-group { margin-bottom: 24px; }
    
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .label-hint {
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      font-size: 0.8rem;
      opacity: 0.7;
    }
    
    input, select {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Platform detection badge */
    .platform-badge {
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .platform-badge.show { display: inline-flex; }
    .platform-badge.youtube { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #ff4444; }
    .platform-badge.soundcloud { background: rgba(255,136,0,0.1); border: 1px solid rgba(255,136,0,0.3); color: #ff8800; }
    .platform-badge.invalid { background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.3); color: #f87171; }
    
    /* Preview */
    .preview-container {
      margin-top: 16px;
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      display: none;
    }
    .preview-container.show { display: block; }
    .preview-container iframe { width: 100%; border: none; }
    .preview-yt { height: 0; padding-bottom: 56.25%; position: relative; }
    .preview-yt iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    .submit-btn {
      background: var(--accent);
      color: #0a0a0f;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
    }
    .submit-btn:hover { opacity: 0.9; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .back-link {
      display: block;
      text-align: center;
      margin-top: 24px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.85rem;
    }
    .back-link:hover { color: var(--text); }
    
    .message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 24px;
      text-align: center;
      display: none;
    }
    .success { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); color: #4ade80; }
    .error { background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); color: #f87171; }
    
    .login-prompt {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
    }
    .login-prompt p { color: var(--muted); margin-bottom: 20px; font-size: 1rem; }
    .login-prompt .login-btn {
      background: var(--accent);
      color: #0a0a0f;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .login-prompt .login-btn:hover { opacity: 0.9; }
    
    @media (max-width: 680px) {
      body { padding: 20px 12px; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Submit Your Track</h1>
  
  <div id="message" class="message"></div>
  
  <div id="loginPrompt" class="login-prompt" style="display: none;">
    <p>You need to be logged in to submit a track.</p>
    <a href="/login.html?redirect=/submit.html" class="login-btn">Log In to Submit</a>
    <a href="/" class="back-link">← Back to home</a>
  </div>
  
  <div id="formContainer" style="display: none;">
    <form id="submitForm">
      <div class="form-group">
        <label>Track URL <span class="label-hint">— YouTube, SoundCloud, Suno or Udio</span></label>
        <input type="url" id="trackUrl" placeholder="Paste a link from any supported platform..." required>
        <div class="platform-badge" id="platformBadge"></div>
        <div class="preview-container" id="previewContainer"></div>
      </div>
      
      <div class="form-group">
        <label>Track Title</label>
        <input type="text" id="title" placeholder="My Awesome AI Track" required maxlength="100">
      </div>
      
      <div class="form-group">
        <label>AI Tool Used</label>
        <select id="tool" required>
          <option value="">Select tool...</option>
          <option value="Suno">Suno</option>
          <option value="Udio">Udio</option>
          <option value="ElevenLabs">ElevenLabs</option>
          <option value="Gemini">Gemini (Lyria)</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Genre</label>
        <select id="genre" required>
          <option value="">Select genre...</option>
          <option value="Pop">Pop</option>
          <option value="Rock">Rock</option>
          <option value="Hip-Hop">Hip-Hop</option>
          <option value="Electronic">Electronic</option>
          <option value="R&B / Soul">R&B / Soul</option>
          <option value="Cinematic">Cinematic</option>
          <option value="Jazz">Jazz</option>
          <option value="Latin">Latin</option>
          <option value="Indie / Folk">Indie / Folk</option>
          <option value="Country">Country</option>
          <option value="Metal">Metal</option>
          <option value="Drum & Bass">Drum & Bass</option>
          <option value="Lo-Fi">Lo-Fi</option>
          <option value="Funk">Funk</option>
          <option value="Reggae">Reggae</option>
          <option value="Blues">Blues</option>
          <option value="Ambient">Ambient</option>
          <option value="Classical">Classical</option>
          <option value="Afrobeat">Afrobeat</option>
          <option value="K-Pop">K-Pop</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <button type="submit" class="submit-btn" id="submitBtn">Submit Track</button>
    </form>
    
    <a href="/" class="back-link">← Back to home</a>
  </div>
</div>

<script type="module">
  const SUPABASE_URL = 'https://gezijezmsecbtzytotax.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_hOOMtCz7gYsu_-CVD6lW9Q_SxtFlNhw';
  
  let currentUser = null;
  let accessToken = null;
  let detectedPlatform = null;
  let detectedId = null;
  let detectedUrl = null;
  
  // ── Auth ──
  async function initAuth() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const hashToken = params.get('access_token');
    
    if (hashToken) {
      accessToken = hashToken;
      localStorage.setItem('sb_token', accessToken);
      window.history.replaceState(null, '', window.location.pathname);
    } else {
      accessToken = localStorage.getItem('sb_token');
    }
    
    if (accessToken) {
      try {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          headers: { 'Authorization': `Bearer ${accessToken}`, 'apikey': SUPABASE_KEY }
        });
        if (res.ok) {
          currentUser = await res.json();
        } else {
          accessToken = null;
          localStorage.removeItem('sb_token');
        }
      } catch (e) {
        accessToken = null;
        localStorage.removeItem('sb_token');
      }
    }
    
    if (currentUser) {
      document.getElementById('formContainer').style.display = 'block';
      document.getElementById('loginPrompt').style.display = 'none';
    } else {
      document.getElementById('formContainer').style.display = 'none';
      document.getElementById('loginPrompt').style.display = 'block';
    }
  }
  
  // ── Platform detection ──
  function parseTrackUrl(url) {
    // YouTube
    const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([^&\?\/\s]+)/);
    if (ytMatch) return { platform: 'youtube', id: ytMatch[1], url: url };
    
    // SoundCloud
    if (url.includes('soundcloud.com/') && url.split('/').length >= 4) {
      return { platform: 'soundcloud', id: url.split('?')[0], url: url };
    }
    
    // Suno - multiple URL formats
    const sunoLong = url.match(/suno\.com\/song\/([a-f0-9-]{36})/);
    if (sunoLong) return { platform: 'suno', id: sunoLong[1], url: url };
    const sunoShort = url.match(/suno\.com\/s\/([a-zA-Z0-9_-]+)/);
    if (sunoShort) return { platform: 'suno-short', id: sunoShort[1], url: url };
    
    // Udio
    if (url.includes('udio.com/songs/')) {
      const udioSlug = url.match(/udio\.com\/songs\/([a-zA-Z0-9_-]+)/);
      if (udioSlug) return { platform: 'udio-resolve', id: udioSlug[1], url: url };
    }
    
    return null;
  }
  
  function showPreview(platform, id) {
    const container = document.getElementById('previewContainer');
    
    if (platform === 'youtube') {
      container.innerHTML = `<div class="preview-yt"><iframe src="https://www.youtube.com/embed/${encodeURIComponent(id)}" allowfullscreen loading="lazy"></iframe></div>`;
    } else if (platform === 'soundcloud') {
      container.innerHTML = `<iframe height="166" scrolling="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=${encodeURIComponent(id)}&color=%23e8ff47&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false" loading="lazy"></iframe>`;
    } else if (platform === 'suno') {
      container.innerHTML = `<iframe height="200" src="https://suno.com/embed/${encodeURIComponent(id)}" loading="lazy" style="border:none;width:100%;border-radius:8px;"></iframe>`;
    } else if (platform === 'udio') {
      container.innerHTML = `<iframe height="200" src="https://www.udio.com/embed/${encodeURIComponent(id)}" scrolling="no" loading="lazy" style="border:none;width:100%;border-radius:8px;"></iframe>`;
    }
    
    container.classList.add('show');
  }
  
  // Live URL detection
  let debounceTimer;
  document.getElementById('trackUrl').addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const url = e.target.value.trim();
      const badge = document.getElementById('platformBadge');
      const preview = document.getElementById('previewContainer');
      
      if (!url) {
        badge.className = 'platform-badge';
        preview.classList.remove('show');
        detectedPlatform = null;
        detectedId = null;
        return;
      }
      
      const result = parseTrackUrl(url);
      
      if (result) {
        // Handle Suno short links
        if (result.platform === 'suno-short') {
          badge.textContent = '♪ Resolving Suno link...';
          badge.className = 'platform-badge show suno';
          preview.innerHTML = `<div style="padding:24px;text-align:center;color:var(--muted);font-size:0.85rem;">Resolving Suno link...</div>`;
          preview.classList.add('show');
          
          try {
            const res = await fetch(`${SUPABASE_URL}/functions/v1/resolve-suno`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
              body: JSON.stringify({ url: result.url })
            });
            const data = await res.json();
            
            if (data.uuid) {
              detectedPlatform = 'suno';
              detectedId = data.uuid;
              detectedUrl = `https://suno.com/song/${data.uuid}`;
              badge.textContent = '♪ Suno detected';
              badge.className = 'platform-badge show suno';
              showPreview('suno', data.uuid);
            } else {
              detectedPlatform = null;
              detectedId = null;
              detectedUrl = null;
              badge.textContent = '✗ Could not resolve Suno link';
              badge.className = 'platform-badge show invalid';
              preview.classList.remove('show');
            }
          } catch (err) {
            detectedPlatform = null;
            detectedId = null;
            detectedUrl = null;
            badge.textContent = '✗ Could not resolve Suno link';
            badge.className = 'platform-badge show invalid';
            preview.classList.remove('show');
          }
          return;
        }

        // Handle Udio slugs
        if (result.platform === 'udio-resolve') {
          badge.textContent = '♪ Resolving Udio link...';
          badge.className = 'platform-badge show udio';
          preview.innerHTML = `<div style="padding:24px;text-align:center;color:var(--muted);font-size:0.85rem;">Resolving Udio link...</div>`;
          preview.classList.add('show');
          
          try {
            const res = await fetch(`${SUPABASE_URL}/functions/v1/resolve-suno`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
              body: JSON.stringify({ url: result.url })
            });
            const data = await res.json();
            
            if (data.uuid) {
              detectedPlatform = 'udio';
              detectedId = data.uuid;
              detectedUrl = `https://www.udio.com/songs/${result.id}`;
              badge.textContent = '♪ Udio detected';
              badge.className = 'platform-badge show udio';
              showPreview('udio', data.uuid);
            } else {
              detectedPlatform = 'udio';
              detectedId = result.id;
              detectedUrl = result.url;
              badge.textContent = '♪ Udio detected';
              badge.className = 'platform-badge show udio';
              showPreview('udio', result.id);
            }
          } catch (err) {
            detectedPlatform = 'udio';
            detectedId = result.id;
            detectedUrl = result.url;
            badge.textContent = '♪ Udio detected';
            badge.className = 'platform-badge show udio';
            showPreview('udio', result.id);
          }
          return;
        }
        
        detectedPlatform = result.platform;
        detectedId = result.id;
        detectedUrl = result.url;
        
        const labels = {
          youtube: '▶ YouTube',
          soundcloud: '☁ SoundCloud',
          suno: '♪ Suno',
          udio: '♪ Udio'
        };
        badge.textContent = labels[result.platform] + ' detected';
        badge.className = `platform-badge show ${result.platform}`;
        showPreview(result.platform, result.id);
      } else {
        detectedPlatform = null;
        detectedId = null;
        detectedUrl = null;
        badge.textContent = '✗ Unsupported URL — use YouTube, SoundCloud, Suno or Udio';
        badge.className = 'platform-badge show invalid';
        preview.classList.remove('show');
      }
    }, 400);
  });
  
  // ── Helpers ──
  function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.className = `message ${type}`;
    msg.textContent = text;
    msg.style.display = 'block';
  }
  
  // ── Form submit ──
  document.getElementById('submitForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    
    const title = document.getElementById('title').value.trim();
    const tool = document.getElementById('tool').value;
    const genre = document.getElementById('genre').value;
    
    if (!detectedPlatform || !detectedId) {
      showMessage('Please enter a valid URL from YouTube, SoundCloud, Suno or Udio', 'error');
      btn.disabled = false;
      btn.textContent = 'Submit Track';
      return;
    }
    
    try {
      let thumbnailUrl = null;
      try {
        btn.textContent = 'Fetching cover art...';
        const thumbRes = await fetch(`${SUPABASE_URL}/functions/v1/fetch-thumbnail`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
          body: JSON.stringify({ url: detectedUrl || `https://www.youtube.com/watch?v=${detectedId}` })
        });
        const thumbData = await thumbRes.json();
        if (thumbData.thumbnail_url) thumbnailUrl = thumbData.thumbnail_url;
      } catch (e) {
        console.warn('Thumbnail fetch failed, continuing without:', e);
      }

      btn.textContent = 'Submitting...';

      const trackData = {
        title,
        yt_id: detectedPlatform === 'youtube' ? detectedId : null,
        embed_url: detectedUrl || null,
        thumbnail_url: thumbnailUrl,
        tool,
        genre,
        votes: 0,
        user_id: currentUser.id
      };
      
      const res = await fetch(`${SUPABASE_URL}/rest/v1/tracks`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(trackData)
      });
      
      if (res.ok) {
        showMessage('✅ Track submitted successfully!', 'success');
        gtag('event', 'track_submit', { tool: trackData.tool, genre: trackData.genre, platform: trackData.platform || 'youtube' });
        document.getElementById('submitForm').reset();
        document.getElementById('platformBadge').className = 'platform-badge';
        document.getElementById('previewContainer').classList.remove('show');
        detectedPlatform = null;
        detectedId = null;
        detectedUrl = null;
        setTimeout(() => window.location.href = '/', 2000);
      } else {
        const err = await res.text();
        console.error('Submit error:', err);
        showMessage('Failed to submit track. Please try again.', 'error');
      }
    } catch (err) {
      console.error('Network error:', err);
      showMessage('Network error. Please try again.', 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'Submit Track';
  });
  
  initAuth();
</script>

</body>
</html>
