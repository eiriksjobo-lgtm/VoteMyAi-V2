<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin ‚Äì VoteMyAI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f; --surface: #111118; --surface-2: #16161f;
      --border: #1e1e2e; --accent: #e8ff47; --text: #f0f0f0;
      --muted: #666680; --success: #4ade80; --error: #f87171; --warn: #fbbf24;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; line-height: 1.6; }
    
    /* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
    .admin-nav {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 32px; height: 56px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .admin-nav .logo {
      font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem;
      letter-spacing: 2px; color: var(--accent); text-decoration: none;
      display: flex; align-items: center; gap: 8px;
    }
    .admin-nav .logo .badge {
      background: rgba(248,113,113,0.15); color: var(--error);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.65rem; font-weight: 700; padding: 2px 8px;
      border-radius: 100px; letter-spacing: 1px;
    }
    .admin-nav a { color: var(--muted); text-decoration: none; font-size: 0.82rem; }
    .admin-nav a:hover { color: var(--text); }

    .container { max-width: 1300px; margin: 0 auto; padding: 32px 24px; }

    /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
    .login-box {
      max-width: 400px; margin: 120px auto; text-align: center;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 48px 32px;
    }
    .login-box h1 {
      font-family: 'Bebas Neue', sans-serif; font-size: 2rem;
      color: var(--accent); margin-bottom: 8px; letter-spacing: 2px;
    }
    .login-box p { color: var(--muted); font-size: 0.85rem; margin-bottom: 28px; }
    .login-box input {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      color: var(--text); padding: 12px 16px; border-radius: 10px;
      font-size: 0.9rem; margin-bottom: 16px; font-family: 'DM Sans', sans-serif;
    }
    .login-box input:focus { outline: none; border-color: var(--accent); }
    .login-box .btn {
      width: 100%; background: var(--accent); color: var(--bg);
      border: none; padding: 12px; border-radius: 10px;
      font-weight: 700; cursor: pointer; font-size: 0.9rem;
      font-family: 'DM Sans', sans-serif; letter-spacing: 0.5px;
    }

    /* ‚îÄ‚îÄ Stats Grid ‚îÄ‚îÄ */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 40px;
    }
    .stat-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 24px;
    }
    .stat-card .stat-label {
      font-size: 0.75rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px;
    }
    .stat-card .stat-value {
      font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem;
      color: var(--accent); letter-spacing: 1px;
    }
    .stat-card .stat-sub {
      font-size: 0.78rem; color: var(--muted); margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      border-bottom: 1px solid var(--border); padding-bottom: 0;
    }
    .tab {
      background: none; border: none; color: var(--muted);
      padding: 10px 20px; cursor: pointer; font-size: 0.85rem;
      font-weight: 600; font-family: 'DM Sans', sans-serif;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      padding: 14px 16px; text-align: left; font-size: 0.75rem;
      color: var(--muted); text-transform: uppercase; letter-spacing: 1px;
      background: var(--surface-2); border-bottom: 1px solid var(--border);
      font-weight: 600;
    }
    td {
      padding: 12px 16px; font-size: 0.85rem;
      border-bottom: 1px solid rgba(30,30,46,0.5);
      max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(232,255,71,0.02); }

    .btn-delete {
      background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2);
      color: var(--error); padding: 5px 12px; border-radius: 6px;
      cursor: pointer; font-size: 0.75rem; font-weight: 600;
      transition: all 0.2s; font-family: 'DM Sans', sans-serif;
    }
    .btn-delete:hover { background: rgba(248,113,113,0.2); }

    .user-badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0.82rem;
    }
    .user-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--accent); color: var(--bg);
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; flex-shrink: 0;
    }
    .text-accent { color: var(--accent); font-weight: 700; }
    .text-muted { color: var(--muted); }
    .text-sm { font-size: 0.78rem; }

    .status {
      padding: 10px 16px; border-radius: 8px; margin-bottom: 16px;
      font-size: 0.85rem; display: none;
    }
    .status.error { display: block; background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); color: var(--error); }
    .status.success { display: block; background: rgba(74,222,128,0.08); border: 1px solid rgba(74,222,128,0.2); color: var(--success); }
    .status.warning { display: block; background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2); color: var(--warn); }

    .empty-state {
      text-align: center; padding: 48px; color: var(--muted); font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .container { padding: 20px 12px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .admin-nav { padding: 0 16px; }
      td, th { padding: 8px 10px; font-size: 0.78rem; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Login ‚îÄ‚îÄ -->
<div id="loginSection">
  <div class="login-box">
    <h1>ADMIN</h1>
    <p>VoteMyAI dashboard ‚Äî authorized access only</p>
    <input type="password" id="passwordInput" placeholder="Password" onkeydown="if(event.key==='Enter')login()">
    <button class="btn" onclick="login()">Login</button>
    <div class="status" id="loginStatus" style="margin-top:16px;"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ -->
<div id="adminPanel" style="display:none;">
  <nav class="admin-nav">
    <a href="/admin.html" class="logo">VOTEMYAI <span class="badge">ADMIN</span></a>
    <a href="/">‚Üê Back to site</a>
  </nav>

  <div class="container">
    <div class="status" id="adminStatus"></div>

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Total Tracks</div>
        <div class="stat-value" id="sTracks">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Votes</div>
        <div class="stat-value" id="sVotes">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Comments</div>
        <div class="stat-value" id="sComments">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Users</div>
        <div class="stat-value" id="sUsers">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Messages</div>
        <div class="stat-value" id="sMessages">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Votes/Track</div>
        <div class="stat-value" id="sAvg">‚Äî</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('users')">üë§ Users</button>
      <button class="tab" onclick="switchTab('tracks')">üìÄ Tracks</button>
      <button class="tab" onclick="switchTab('comments')">üí¨ Comments</button>
      <button class="tab" onclick="switchTab('messages')">üì¨ Messages</button>
    </div>

    <!-- Users Tab -->
    <div class="tab-content active" id="tab-users">
      <div class="table-wrap">
        <table id="usersTable">
          <tr><th>User</th><th>Email</th><th>Tracks</th><th>Votes Given</th><th>Comments</th><th>Joined</th></tr>
        </table>
      </div>
    </div>

    <!-- Tracks Tab -->
    <div class="tab-content" id="tab-tracks">
      <div class="table-wrap">
        <table id="tracksTable">
          <tr><th>Title</th><th>Tool</th><th>Genre</th><th>Votes</th><th>Submitted</th><th>Actions</th></tr>
        </table>
      </div>
    </div>

    <!-- Comments Tab -->
    <div class="tab-content" id="tab-comments">
      <div class="table-wrap">
        <table id="commentsTable">
          <tr><th>Track</th><th>Author</th><th>Comment</th><th>Date</th><th>Actions</th></tr>
        </table>
      </div>
    </div>

    <!-- Messages Tab -->
    <div class="tab-content" id="tab-messages">
      <div class="table-wrap">
        <table id="messagesTable">
          <tr><th>Name</th><th>Email</th><th>Message</th><th>Date</th><th>Actions</th></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
  const SUPABASE_URL = 'https://gezijezmsecbtzytotax.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_hOOMtCz7gYsu_-CVD6lW9Q_SxtFlNhw';
  const ADMIN_PASSWORD = '5p1elBerg!';
  
  let token = localStorage.getItem('sb_token');
  
  // Handle OAuth return
  const hash = window.location.hash.substring(1);
  const hashParams = new URLSearchParams(hash);
  const hashToken = hashParams.get('access_token');
  if (hashToken) {
    token = hashToken;
    localStorage.setItem('sb_token', token);
    window.history.replaceState(null, '', window.location.pathname);
  }
  
  function sanitize(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }
  
  function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = `status ${type}`;
    if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 3000);
  }
  
  function authHeaders() {
    const h = { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' };
    if (token) h['Authorization'] = `Bearer ${token}`;
    return h;
  }
  
  function formatDate(d) {
    if (!d) return '‚Äî';
    return new Date(d).toLocaleDateString('no-NO', { day: 'numeric', month: 'short', year: 'numeric' });
  }
  
  function getInitials(name, email) {
    if (name) return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    if (email) return email[0].toUpperCase();
    return '?';
  }

  // ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
  window.switchTab = function(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
  };

  // ‚îÄ‚îÄ Login ‚îÄ‚îÄ
  window.login = async function() {
    if (document.getElementById('passwordInput').value !== ADMIN_PASSWORD) {
      showStatus('loginStatus', 'Wrong password', 'error');
      return;
    }
    token = localStorage.getItem('sb_token');
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    loadData();
  };

  // ‚îÄ‚îÄ Load all data ‚îÄ‚îÄ
  async function loadData() {
    try {
      // Parallel fetch
      const [tracksRes, commentsRes, messagesRes, votesRes] = await Promise.all([
        fetch(`${SUPABASE_URL}/rest/v1/tracks?select=*&order=created_at.desc`, { headers: authHeaders() }),
        fetch(`${SUPABASE_URL}/rest/v1/comments?select=*,tracks(title)&order=created_at.desc`, { headers: authHeaders() }),
        fetch(`${SUPABASE_URL}/rest/v1/contact_messages?select=*&order=created_at.desc`, { headers: authHeaders() }),
        fetch(`${SUPABASE_URL}/rest/v1/votes?select=*`, { headers: authHeaders() })
      ]);

      const tracks = await tracksRes.json();
      const comments = await commentsRes.json();
      const messages = await messagesRes.json();
      const votes = await votesRes.json();

      // ‚îÄ‚îÄ Build user data from tracks, votes, comments ‚îÄ‚îÄ
      const userMap = {};
      
      // From tracks (has user_id if logged in)
      tracks.forEach(t => {
        if (t.user_id) {
          if (!userMap[t.user_id]) userMap[t.user_id] = { tracks: 0, votes: 0, comments: 0, email: '', name: '', joined: t.created_at };
          userMap[t.user_id].tracks++;
          if (t.created_at < userMap[t.user_id].joined) userMap[t.user_id].joined = t.created_at;
        }
      });

      // From votes
      votes.forEach(v => {
        if (v.user_id) {
          if (!userMap[v.user_id]) userMap[v.user_id] = { tracks: 0, votes: 0, comments: 0, email: '', name: '', joined: v.created_at || '' };
          userMap[v.user_id].votes++;
        }
      });

      // From comments (has author_name)
      comments.forEach(c => {
        if (c.user_id) {
          if (!userMap[c.user_id]) userMap[c.user_id] = { tracks: 0, votes: 0, comments: 0, email: '', name: '', joined: c.created_at || '' };
          userMap[c.user_id].comments++;
          if (c.author_name) userMap[c.user_id].name = c.author_name;
        }
      });

      // Try to get user details from auth (may fail with anon key, that's fine)
      try {
        // We can fetch user emails from tracks/comments metadata if available
        // For now, show user_id or author_name
      } catch(e) {}

      const users = Object.entries(userMap).map(([id, data]) => ({ id, ...data }));
      users.sort((a, b) => (b.tracks + b.votes + b.comments) - (a.tracks + a.votes + a.comments));

      // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
      const totalVotes = tracks.reduce((sum, t) => sum + (parseInt(t.votes) || 0), 0);
      document.getElementById('sTracks').textContent = tracks.length;
      document.getElementById('sVotes').textContent = totalVotes;
      document.getElementById('sComments').textContent = comments.length;
      document.getElementById('sUsers').textContent = users.length;
      document.getElementById('sMessages').textContent = messages.length;
      document.getElementById('sAvg').textContent = tracks.length ? (totalVotes / tracks.length).toFixed(1) : '0';

      // ‚îÄ‚îÄ Users table ‚îÄ‚îÄ
      const usersTable = document.getElementById('usersTable');
      usersTable.innerHTML = `
        <tr><th>User</th><th>User ID</th><th>Tracks</th><th>Votes Given</th><th>Comments</th><th>First Seen</th><th>Actions</th></tr>
        ${users.length ? users.map(u => `
          <tr>
            <td>
              <span class="user-badge">
                <span class="user-avatar">${getInitials(u.name, u.id)}</span>
                ${sanitize(u.name || 'Anonymous')}
              </span>
            </td>
            <td class="text-muted text-sm">${u.id.substring(0, 8)}...</td>
            <td class="text-accent">${u.tracks}</td>
            <td>${u.votes}</td>
            <td>${u.comments}</td>
            <td class="text-muted">${formatDate(u.joined)}</td>
            <td><button class="btn-delete" onclick="deleteUser('${u.id}')">Delete</button></td>
          </tr>
        `).join('') : '<tr><td colspan="7" class="empty-state">No users yet</td></tr>'}
      `;

      // ‚îÄ‚îÄ Tracks table ‚îÄ‚îÄ
      document.getElementById('tracksTable').innerHTML = `
        <tr><th>Title</th><th>Tool</th><th>Genre</th><th>Votes</th><th>Submitted</th><th>Actions</th></tr>
        ${tracks.length ? tracks.map(t => `
          <tr>
            <td><strong>${sanitize(t.title)}</strong></td>
            <td>${sanitize(t.tool)}</td>
            <td>${sanitize(t.genre)}</td>
            <td class="text-accent">${t.votes || 0}</td>
            <td class="text-muted">${formatDate(t.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteTrack('${t.id}')">Delete</button></td>
          </tr>
        `).join('') : '<tr><td colspan="6" class="empty-state">No tracks yet</td></tr>'}
      `;

      // ‚îÄ‚îÄ Comments table ‚îÄ‚îÄ
      document.getElementById('commentsTable').innerHTML = `
        <tr><th>Track</th><th>Author</th><th>Comment</th><th>Date</th><th>Actions</th></tr>
        ${comments.length ? comments.map(c => `
          <tr>
            <td>${sanitize(c.tracks?.title || 'Unknown')}</td>
            <td>${sanitize(c.author_name || 'Anonymous')}</td>
            <td>${sanitize(c.content)}</td>
            <td class="text-muted">${formatDate(c.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteComment('${c.id}')">Delete</button></td>
          </tr>
        `).join('') : '<tr><td colspan="5" class="empty-state">No comments yet</td></tr>'}
      `;

      // ‚îÄ‚îÄ Messages table ‚îÄ‚îÄ
      document.getElementById('messagesTable').innerHTML = `
        <tr><th>Name</th><th>Email</th><th>Message</th><th>Date</th><th>Actions</th></tr>
        ${messages.length ? messages.map(m => `
          <tr>
            <td>${sanitize(m.name)}</td>
            <td>${sanitize(m.email)}</td>
            <td>${sanitize(m.message)}</td>
            <td class="text-muted">${formatDate(m.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteMessage('${m.id}')">Delete</button></td>
          </tr>
        `).join('') : '<tr><td colspan="5" class="empty-state">No messages yet</td></tr>'}
      `;

    } catch (err) {
      console.error('Load error:', err);
      showStatus('adminStatus', 'Failed to load data: ' + err.message, 'error');
    }
  }

  // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ
  async function adminDelete(table, id, label) {
    if (!confirm(`Delete this ${label}?`)) return;
    token = localStorage.getItem('sb_token');
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
        method: 'DELETE',
        headers: authHeaders()
      });
      if (res.ok || res.status === 204) {
        showStatus('adminStatus', `${label} deleted.`, 'success');
        await loadData();
      } else if (res.status === 401 || res.status === 403) {
        showStatus('adminStatus', 'Not authorized. Log in on main site first.', 'error');
      } else {
        const errText = await res.text();
        if (errText.includes('policy') || errText.includes('permission')) {
          showStatus('adminStatus', 'Cannot delete ‚Äî RLS policy missing in Supabase.', 'error');
        } else {
          showStatus('adminStatus', `Failed to delete. Status: ${res.status}`, 'error');
        }
      }
    } catch (err) {
      showStatus('adminStatus', `Network error: ${err.message}`, 'error');
    }
  }

  window.deleteTrack = (id) => adminDelete('tracks', id, 'Track');
  window.deleteComment = (id) => adminDelete('comments', id, 'Comment');
  window.deleteMessage = (id) => adminDelete('contact_messages', id, 'Message');

  window.deleteUser = async function(userId) {
    if (!confirm(`Delete this user and ALL their data (tracks, votes, comments)?`)) return;
    token = localStorage.getItem('sb_token');
    try {
      // Delete user's votes, comments, then tracks (order matters for foreign keys)
      const tables = [
        { name: 'votes', filter: `user_id=eq.${userId}` },
        { name: 'comments', filter: `user_id=eq.${userId}` },
        { name: 'tracks', filter: `user_id=eq.${userId}` }
      ];
      for (const t of tables) {
        await fetch(`${SUPABASE_URL}/rest/v1/${t.name}?${t.filter}`, {
          method: 'DELETE',
          headers: authHeaders()
        });
      }
      showStatus('adminStatus', 'User and all their data deleted.', 'success');
      await loadData();
    } catch (err) {
      showStatus('adminStatus', `Error deleting user: ${err.message}`, 'error');
    }
  };
</script>

</body>
</html>
