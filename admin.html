<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin – VoteMyAI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #07070b; --surface: #0e0e14; --surface-2: #131319;
      --border: #1a1a26; --border-hover: #252535;
      --accent: #e8ff47; --accent-dim: rgba(232,255,71,0.12);
      --text: #f2f2f4; --text-secondary: #a8a8b8; --muted: #5c5c72;
      --success: #4ade80; --error: #f87171; --warn: #fbbf24;
      --radius: 14px; --radius-sm: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; line-height: 1.6; -webkit-font-smoothing: antialiased; }
    ::selection { background: var(--accent); color: var(--bg); }

    .admin-nav {
      position: sticky; top: 0; z-index: 200;
      background: rgba(7,7,11,0.88); backdrop-filter: blur(24px) saturate(1.4);
      border-bottom: 1px solid rgba(26,26,38,0.6);
      height: 60px; display: flex; align-items: center; justify-content: space-between;
      padding: 0 clamp(16px, 4vw, 40px);
    }
    .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 3px; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .logo-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .logo .badge { background: rgba(248,113,113,0.15); color: var(--error); font-family: 'DM Sans', sans-serif; font-size: 0.6rem; font-weight: 700; padding: 2px 8px; border-radius: 100px; letter-spacing: 1px; }
    .admin-nav a { color: var(--muted); text-decoration: none; font-size: 0.72rem; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; padding: 8px 14px; border-radius: 8px; transition: all 0.2s; }
    .admin-nav a:hover { color: var(--text); background: rgba(255,255,255,0.04); }

    .container { max-width: 1300px; margin: 0 auto; padding: 32px clamp(16px, 4vw, 40px); }

    /* Login */
    .login-box {
      max-width: 400px; margin: 120px auto; text-align: center;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 48px 32px;
    }
    .login-box h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--accent); margin-bottom: 8px; letter-spacing: 3px; }
    .login-box p { color: var(--muted); font-size: 0.82rem; margin-bottom: 28px; }
    .login-box input {
      width: 100%; background: var(--surface-2); border: 1px solid var(--border); color: var(--text);
      padding: 12px 16px; border-radius: var(--radius-sm); font-size: 0.88rem; margin-bottom: 16px;
      font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s;
    }
    .login-box input:focus { border-color: var(--accent); }
    .login-box .btn {
      width: 100%; background: var(--accent); color: var(--bg); border: none; padding: 12px;
      border-radius: var(--radius-sm); font-weight: 700; cursor: pointer; font-size: 0.85rem;
      font-family: 'DM Sans', sans-serif; letter-spacing: 0.5px; transition: all 0.2s;
    }
    .login-box .btn:hover { box-shadow: 0 4px 20px rgba(232,255,71,0.25); }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 32px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
    .stat-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 6px; }
    .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--accent); letter-spacing: 1px; line-height: 1; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .tab {
      background: none; border: none; color: var(--muted); padding: 10px 20px; cursor: pointer;
      font-size: 0.78rem; font-weight: 600; font-family: 'DM Sans', sans-serif;
      border-bottom: 2px solid transparent; transition: all 0.2s; letter-spacing: 0.5px;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Tables */
    .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { padding: 12px 16px; text-align: left; font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; background: var(--surface-2); border-bottom: 1px solid var(--border); font-weight: 600; }
    td { padding: 10px 16px; font-size: 0.82rem; border-bottom: 1px solid rgba(26,26,38,0.5); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(232,255,71,0.02); }

    .btn-delete { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); color: var(--error); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: 600; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
    .btn-delete:hover { background: rgba(248,113,113,0.2); }
    .btn-edit { background: rgba(232,255,71,0.08); border: 1px solid rgba(232,255,71,0.2); color: var(--accent); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: 600; transition: all 0.2s; font-family: 'DM Sans', sans-serif; margin-right: 4px; }
    .btn-edit:hover { background: rgba(232,255,71,0.15); }

    .user-badge { display: inline-flex; align-items: center; gap: 8px; }
    .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); color: var(--bg); display: inline-flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; flex-shrink: 0; overflow: hidden; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .text-accent { color: var(--accent); font-weight: 700; }
    .text-muted { color: var(--muted); }
    .text-sm { font-size: 0.75rem; }
    .text-email { color: var(--text-secondary); font-size: 0.78rem; }

    .status { padding: 10px 16px; border-radius: var(--radius-sm); margin-bottom: 16px; font-size: 0.82rem; display: none; }
    .status.error { display: block; background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); color: var(--error); }
    .status.success { display: block; background: rgba(74,222,128,0.08); border: 1px solid rgba(74,222,128,0.2); color: var(--success); }

    .empty-state { text-align: center; padding: 48px; color: var(--muted); font-size: 0.85rem; }
    .loading { text-align: center; padding: 32px; color: var(--muted); font-size: 0.82rem; }

    @media (max-width: 768px) {
      .container { padding: 20px 12px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      td, th { padding: 8px 10px; font-size: 0.75rem; }
      .tab { padding: 8px 12px; font-size: 0.7rem; }
    }
  </style>
</head>
<body>

<div id="loginSection">
  <div class="login-box">
    <h1>ADMIN</h1>
    <p>VoteMyAI dashboard — authorized access only</p>
    <input type="password" id="passwordInput" placeholder="Password" onkeydown="if(event.key==='Enter')login()">
    <button class="btn" onclick="login()">Login</button>
    <div class="status" id="loginStatus" style="margin-top:16px;"></div>
  </div>
</div>

<div id="adminPanel" style="display:none;">
  <nav class="admin-nav">
    <a href="/admin.html" class="logo"><span class="logo-dot"></span>VOTEMYAI <span class="badge">ADMIN</span></a>
    <a href="/">← Back to site</a>
  </nav>

  <div class="container">
    <div class="status" id="adminStatus"></div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Tracks</div><div class="stat-value" id="sTracks">—</div></div>
      <div class="stat-card"><div class="stat-label">Ratings</div><div class="stat-value" id="sRatings">—</div></div>
      <div class="stat-card"><div class="stat-label">Comments</div><div class="stat-value" id="sComments">—</div></div>
      <div class="stat-card"><div class="stat-label">Users</div><div class="stat-value" id="sUsers">—</div></div>
      <div class="stat-card"><div class="stat-label">Messages</div><div class="stat-value" id="sMessages">—</div></div>
      <div class="stat-card"><div class="stat-label">Avg Rating</div><div class="stat-value" id="sAvg">—</div></div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('users', this)">Users</button>
      <button class="tab" onclick="switchTab('tracks', this)">Tracks</button>
      <button class="tab" onclick="switchTab('comments', this)">Comments</button>
      <button class="tab" onclick="switchTab('messages', this)">Messages</button>
    </div>

    <div class="tab-content active" id="tab-users"><div class="loading">Loading users...</div></div>
    <div class="tab-content" id="tab-tracks"><div class="loading">Loading tracks...</div></div>
    <div class="tab-content" id="tab-comments"><div class="loading">Loading comments...</div></div>
    <div class="tab-content" id="tab-messages"><div class="loading">Loading messages...</div></div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://gezijezmsecbtzytotax.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_hOOMtCz7gYsu_-CVD6lW9Q_SxtFlNhw';
  let adminPassword = '';
  let authUsers = [];

  function sanitize(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
  function formatDate(d) { if (!d) return '\u2014'; return new Date(d).toLocaleDateString('no-NO', { day: 'numeric', month: 'short', year: 'numeric' }); }

  function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg; el.className = `status ${type}`;
    if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 3000);
  }

  function headers() {
    return { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' };
  }

  window.switchTab = function(tab, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
  };

  window.login = async function() {
    adminPassword = document.getElementById('passwordInput').value;
    // Verify password by calling edge function
    try {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/admin-users`, {
        headers: { 'x-admin-password': adminPassword }
      });
      if (!res.ok) {
        showStatus('loginStatus', 'Wrong password', 'error');
        return;
      }
      const data = await res.json();
      authUsers = data.users || [];
    } catch(e) {
      showStatus('loginStatus', 'Could not connect', 'error');
      return;
    }
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    loadData();
  };

  async function loadData() {
    try {
      const [tracksRes, commentsRes, messagesRes, ratingsRes] = await Promise.all([
        fetch(`${SUPABASE_URL}/rest/v1/tracks?select=*&order=created_at.desc`, { headers: headers() }),
        fetch(`${SUPABASE_URL}/rest/v1/comments?select=*,tracks(title)&order=created_at.desc`, { headers: headers() }),
        fetch(`${SUPABASE_URL}/rest/v1/contact_messages?select=*&order=created_at.desc`, { headers: headers() }),
        fetch(`${SUPABASE_URL}/rest/v1/anonymous_ratings?select=*`, { headers: headers() })
      ]);

      const tracks = await tracksRes.json();
      const comments = await commentsRes.json();
      const messages = await messagesRes.json();
      const ratings = await ratingsRes.json();

      // Build user map from auth data
      const userMap = {};
      authUsers.forEach(u => {
        userMap[u.id] = { ...u, trackCount: 0, ratingCount: 0, commentCount: 0 };
      });

      tracks.forEach(t => {
        if (t.user_id && userMap[t.user_id]) userMap[t.user_id].trackCount++;
      });
      comments.forEach(c => {
        if (c.user_id && userMap[c.user_id]) userMap[c.user_id].commentCount++;
      });

      const users = Object.values(userMap);
      users.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // Stats
      const totalRatings = tracks.reduce((s, t) => s + (t.rating_count || 0), 0);
      const ratedTracks = tracks.filter(t => t.rating_count > 0);
      const avgRating = ratedTracks.length ? (ratedTracks.reduce((s, t) => s + (parseFloat(t.avg_rating) || 0), 0) / ratedTracks.length).toFixed(1) : '\u2014';

      document.getElementById('sTracks').textContent = tracks.length;
      document.getElementById('sRatings').textContent = totalRatings;
      document.getElementById('sComments').textContent = comments.length;
      document.getElementById('sUsers').textContent = users.length;
      document.getElementById('sMessages').textContent = messages.length;
      document.getElementById('sAvg').textContent = avgRating;

      // Users table
      document.getElementById('tab-users').innerHTML = `<div class="table-wrap"><table>
        <tr><th>User</th><th>Email</th><th>Tracks</th><th>Comments</th><th>Joined</th><th>Actions</th></tr>
        ${users.length ? users.map(u => {
          const name = sanitize(u.name || 'No name');
          const avatarHtml = u.avatar ? `<img src="${sanitize(u.avatar)}" alt="">` : (u.name || u.email || '?').charAt(0).toUpperCase();
          return `<tr>
            <td><span class="user-badge"><span class="user-avatar">${avatarHtml}</span>${name}</span></td>
            <td class="text-email">${sanitize(u.email)}</td>
            <td class="text-accent">${u.trackCount}</td>
            <td>${u.commentCount}</td>
            <td class="text-muted">${formatDate(u.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteUser('${u.id}')">Delete</button></td>
          </tr>`;
        }).join('') : '<tr><td colspan="6" class="empty-state">No users yet</td></tr>'}
      </table></div>`;

      // Tracks table
      document.getElementById('tab-tracks').innerHTML = `<div class="table-wrap"><table>
        <tr><th>Title</th><th>Submitted By</th><th>Tool</th><th>Genre</th><th>Avg Rating</th><th>Ratings</th><th>Submitted</th><th>Actions</th></tr>
        ${tracks.length ? tracks.map(t => {
          const user = t.user_id && userMap[t.user_id] ? userMap[t.user_id] : null;
          const submitter = user ? sanitize(user.name || user.email || 'Unknown') : '<span class="text-muted">Unknown</span>';
          const avg = t.avg_rating ? parseFloat(t.avg_rating).toFixed(1) : '\u2014';
          return `<tr>
            <td><strong>${sanitize(t.title)}</strong></td>
            <td class="text-sm">${submitter}</td>
            <td>${sanitize(t.tool)}</td>
            <td>${sanitize(t.genre)}</td>
            <td class="text-accent">${avg}</td>
            <td>${t.rating_count || 0}</td>
            <td class="text-muted">${formatDate(t.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteTrack('${t.id}')">Delete</button></td>
          </tr>`;
        }).join('') : '<tr><td colspan="8" class="empty-state">No tracks yet</td></tr>'}
      </table></div>`;

      // Comments table
      document.getElementById('tab-comments').innerHTML = `<div class="table-wrap"><table>
        <tr><th>Track</th><th>Author</th><th>Email</th><th>Comment</th><th>Date</th><th>Actions</th></tr>
        ${comments.length ? comments.map(c => {
          const user = c.user_id && userMap[c.user_id] ? userMap[c.user_id] : null;
          const email = user ? sanitize(user.email) : '<span class="text-muted">\u2014</span>';
          return `<tr>
            <td>${sanitize(c.tracks?.title || 'Unknown')}</td>
            <td>${sanitize(c.author_name || 'Anonymous')}</td>
            <td class="text-email text-sm">${email}</td>
            <td>${sanitize(c.content)}</td>
            <td class="text-muted">${formatDate(c.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteComment('${c.id}')">Delete</button></td>
          </tr>`;
        }).join('') : '<tr><td colspan="6" class="empty-state">No comments yet</td></tr>'}
      </table></div>`;

      // Messages table
      document.getElementById('tab-messages').innerHTML = `<div class="table-wrap"><table>
        <tr><th>Name</th><th>Email</th><th>Message</th><th>Date</th><th>Actions</th></tr>
        ${messages.length ? messages.map(m => `<tr>
            <td>${sanitize(m.name)}</td>
            <td class="text-email">${sanitize(m.email)}</td>
            <td>${sanitize(m.message)}</td>
            <td class="text-muted">${formatDate(m.created_at)}</td>
            <td><button class="btn-delete" onclick="deleteMessage('${m.id}')">Delete</button></td>
          </tr>`).join('') : '<tr><td colspan="5" class="empty-state">No messages yet</td></tr>'}
      </table></div>`;

    } catch(err) {
      console.error('Load error:', err);
      showStatus('adminStatus', 'Failed to load data: ' + err.message, 'error');
    }
  }

  async function adminDelete(table, id, label) {
    if (!confirm(`Delete this ${label}?`)) return;
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, { method: 'DELETE', headers: headers() });
      if (res.ok || res.status === 204) {
        showStatus('adminStatus', `${label} deleted.`, 'success');
        await loadData();
      } else {
        showStatus('adminStatus', `Failed to delete ${label}. Check RLS policies.`, 'error');
      }
    } catch(err) { showStatus('adminStatus', `Error: ${err.message}`, 'error'); }
  }

  window.deleteTrack = (id) => adminDelete('tracks', id, 'Track');
  window.deleteComment = (id) => adminDelete('comments', id, 'Comment');
  window.deleteMessage = (id) => adminDelete('contact_messages', id, 'Message');

  window.deleteUser = async function(userId) {
    if (!confirm('Delete this user and ALL their data (tracks, comments)?')) return;
    try {
      await fetch(`${SUPABASE_URL}/rest/v1/comments?user_id=eq.${userId}`, { method: 'DELETE', headers: headers() });
      await fetch(`${SUPABASE_URL}/rest/v1/tracks?user_id=eq.${userId}`, { method: 'DELETE', headers: headers() });
      showStatus('adminStatus', 'User data deleted.', 'success');
      await loadData();
    } catch(err) { showStatus('adminStatus', `Error: ${err.message}`, 'error'); }
  };
</script>
</body>
</html>
