<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoteMyAI</title>
  <meta name="theme-color" content="#e8ff47">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --border: #1e1e2e;
      --accent: #e8ff47;
      --text: #f0f0f0;
      --muted: #666680;
      --player-h: 72px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      font-family: 'DM Sans', sans-serif;
    }

    /* ── Page iframe ── */
    #page-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      transition: height 0.3s ease;
    }

    body.player-active #page-frame {
      height: calc(100% - var(--player-h));
    }

    /* ── Player Bar ── */
    #player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--player-h);
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      z-index: 9999;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.player-active #player-bar {
      transform: translateY(0);
    }

    /* Track info */
    .player-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .player-title {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-tool {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Controls */
    .player-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s, background 0.15s;
      background: transparent;
      color: var(--text);
    }

    .player-btn:hover {
      transform: scale(1.1);
    }

    .player-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .player-btn.play-pause {
      width: 44px;
      height: 44px;
      background: var(--accent);
      color: var(--bg);
    }

    .player-btn.play-pause:hover {
      box-shadow: 0 0 20px rgba(232, 255, 71, 0.3);
    }

    .player-btn.close-btn {
      color: var(--muted);
    }

    .player-btn.close-btn:hover {
      color: var(--text);
    }

    /* Hidden embed container */
    #player-embed {
      width: 0;
      height: 0;
      overflow: hidden;
      position: absolute;
      left: -9999px;
    }

    /* Progress bar */
    .player-progress {
      position: absolute;
      top: -3px;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(255,255,255,0.06);
      cursor: pointer;
    }

    .player-progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s linear;
      border-radius: 0 2px 2px 0;
    }

    .player-progress:hover {
      height: 5px;
      top: -5px;
    }

    .player-progress:hover .player-progress-fill {
      box-shadow: 0 0 8px rgba(232, 255, 71, 0.5);
    }

    /* Now playing indicator */
    .now-playing-dots {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 16px;
      padding-right: 4px;
    }

    .now-playing-dots span {
      width: 3px;
      background: var(--accent);
      border-radius: 2px;
      animation: eq 0.8s ease-in-out infinite alternate;
    }

    .now-playing-dots span:nth-child(1) { height: 8px; animation-delay: 0s; }
    .now-playing-dots span:nth-child(2) { height: 14px; animation-delay: 0.15s; }
    .now-playing-dots span:nth-child(3) { height: 6px; animation-delay: 0.3s; }
    .now-playing-dots span:nth-child(4) { height: 12px; animation-delay: 0.45s; }

    body:not(.is-playing) .now-playing-dots span {
      animation-play-state: paused;
    }

    @keyframes eq {
      0% { height: 4px; }
      100% { height: 16px; }
    }

    /* Mobile */
    @media (max-width: 640px) {
      :root { --player-h: 64px; }
      #player-bar { padding: 0 12px; gap: 10px; }
      .player-title { font-size: 0.82rem; }
      .player-btn { width: 36px; height: 36px; }
      .player-btn.play-pause { width: 40px; height: 40px; }
      .player-btn svg { width: 18px; height: 18px; }
    }
  </style>
</head>
<body>

<!-- Page content loads here -->
<iframe id="page-frame" src="about:blank"></iframe>

<!-- Hidden audio/embed container -->
<div id="player-embed"></div>

<!-- Persistent Player Bar -->
<div id="player-bar">
  <div class="player-progress" id="progressBar" onclick="seekTo(event)">
    <div class="player-progress-fill" id="progressFill"></div>
  </div>

  <div class="now-playing-dots">
    <span></span><span></span><span></span><span></span>
  </div>

  <div class="player-info">
    <div class="player-title" id="playerTitle">—</div>
    <div class="player-tool" id="playerTool"></div>
  </div>

  <div class="player-controls">
    <!-- Rewind 10s -->
    <button class="player-btn" onclick="seekRelative(-10)" title="Rewind 10s">
      <svg viewBox="0 0 24 24"><path d="M12.5 3C7.53 3 3.5 7.03 3.5 12s4.03 9 9 9 9-4.03 9-9h-2c0 3.87-3.13 7-7 7s-7-3.13-7-7 3.13-7 7-7v4l5-5-5-5v4z"/><text x="9" y="16" font-size="8" fill="currentColor" font-family="sans-serif" font-weight="bold">10</text></svg>
    </button>

    <!-- Play/Pause -->
    <button class="player-btn play-pause" id="btnPlayPause" onclick="togglePlayPause()" title="Play / Pause">
      <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>

    <!-- Forward 10s -->
    <button class="player-btn" onclick="seekRelative(10)" title="Forward 10s">
      <svg viewBox="0 0 24 24"><path d="M11.5 3v4l-5-5 5-5v4c4.97 0 9 4.03 9 9s-4.03 9-9 9-9-4.03-9-9h2c0 3.87 3.13 7 7 7s7-3.13 7-7-3.13-7-7-7z"/><text x="8" y="16" font-size="8" fill="currentColor" font-family="sans-serif" font-weight="bold">10</text></svg>
    </button>

    <!-- Close -->
    <button class="player-btn close-btn" onclick="closePlayer()" title="Close player">
      <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
  </div>
</div>

<script>
  // ── State ──
  let isPlaying = false;
  let currentTrack = null; // { title, tool, embedHtml, platform }
  let ytPlayer = null;
  let progressInterval = null;

  const pageFrame = document.getElementById('page-frame');
  const playerBar = document.getElementById('player-bar');
  const playerEmbed = document.getElementById('player-embed');
  const playerTitle = document.getElementById('playerTitle');
  const playerTool = document.getElementById('playerTool');
  const iconPlay = document.getElementById('iconPlay');
  const iconPause = document.getElementById('iconPause');
  const progressFill = document.getElementById('progressFill');

  // ── Load initial page ──
  function getInitialPage() {
    const params = new URLSearchParams(window.location.search);
    const p = params.get('p');
    if (p) return p;

    // Map current path to real file
    const path = window.location.pathname;
    if (path === '/' || path === '/app.html') return '/index.html';
    return path;
  }

  // Load the page, adding noshell param so pages don't try to redirect
  function loadPage(url) {
    const separator = url.includes('?') ? '&' : '?';
    pageFrame.src = url + separator + 'noshell=1';
  }

  loadPage(getInitialPage());

  // ── Update browser URL when iframe navigates ──
  pageFrame.addEventListener('load', () => {
    try {
      let iframeUrl = pageFrame.contentWindow.location.pathname;
      // Remove noshell from displayed URL
      if (iframeUrl && iframeUrl !== 'about:blank') {
        // Show clean URL
        let displayUrl = iframeUrl.replace('/index.html', '/');
        if (displayUrl !== window.location.pathname) {
          window.history.replaceState(null, '', displayUrl);
        }
        // Update page title
        const iframeTitle = pageFrame.contentDocument?.title;
        if (iframeTitle) document.title = iframeTitle;
      }
    } catch (e) {
      // Cross-origin iframe, ignore
    }

    // Intercept links in the iframe to keep them in the frame
    try {
      interceptLinks();
    } catch (e) {}
  });

  // ── Intercept links and play buttons inside iframe ──
  function interceptLinks() {
    const doc = pageFrame.contentDocument;
    if (!doc) return;

    // Intercept navigation links
    doc.addEventListener('click', (e) => {
      // ── Check for Play button clicks ──
      const playBtn = e.target.closest('[data-action="play-bar"]');
      if (playBtn) {
        e.preventDefault();
        e.stopPropagation();
        const embedHtml = playBtn.dataset.embed ? decodeURIComponent(playBtn.dataset.embed) : '';
        const title = playBtn.dataset.title || 'Now Playing';
        const tool = playBtn.dataset.tool || '';
        const platform = playBtn.dataset.platform || 'youtube';
        const trackId = playBtn.dataset.trackId || '';

        // For YouTube, extract video ID from embed HTML
        let embedData = embedHtml;
        if (platform === 'youtube') {
          const match = embedHtml.match(/youtube\.com\/embed\/([^"?&]+)/);
          if (match) embedData = match[1];
        }

        playTrack({ title, tool, embedHtml: embedData, platform });
        return;
      }

      // ── Check for navigation links ──
      const link = e.target.closest('a');
      if (!link) return;

      const href = link.getAttribute('href');
      if (!href) return;

      // External links open normally in new tab
      if (href.startsWith('http') && !href.includes('votemyai.com')) return;
      // Hash links work normally inside iframe
      if (href.startsWith('#')) return;
      // javascript: links work normally
      if (href.startsWith('javascript:')) return;

      e.preventDefault();
      const url = href.startsWith('/') ? href : '/' + href;
      loadPage(url);
    });
  }

  // ── Play Track (called from iframe via postMessage) ──
  window.addEventListener('message', (e) => {
    if (e.data?.type === 'play-track') {
      playTrack(e.data);
    }
  });

  function playTrack({ title, tool, embedHtml, platform }) {
    currentTrack = { title, tool, embedHtml, platform };
    playerTitle.textContent = title || 'Now Playing';
    playerTool.textContent = tool || '';

    // Activate player bar
    document.body.classList.add('player-active', 'is-playing');

    // Insert embed
    playerEmbed.innerHTML = '';

    if (platform === 'youtube') {
      // Use YouTube iframe API for play/pause/seek control
      playerEmbed.innerHTML = `<div id="yt-player-container" style="width:320px;height:180px;"></div>`;
      loadYouTubePlayer(embedHtml); // embedHtml = video ID for YT
    } else {
      // For Suno/Udio/SoundCloud — use iframe embed (limited control)
      playerEmbed.innerHTML = embedHtml;
      // Make embed visible enough to play but off-screen
      const iframe = playerEmbed.querySelector('iframe');
      if (iframe) {
        iframe.style.width = '320px';
        iframe.style.height = '180px';
        iframe.allow = 'autoplay';
      }
    }

    isPlaying = true;
    updatePlayPauseIcon();
    startProgress();
  }

  // ── YouTube Player API ──
  let ytApiReady = false;

  function loadYouTubeAPI() {
    if (window.YT && window.YT.Player) {
      ytApiReady = true;
      return;
    }
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
  }

  window.onYouTubeIframeAPIReady = function () {
    ytApiReady = true;
  };

  loadYouTubeAPI();

  function loadYouTubePlayer(videoId) {
    if (ytPlayer) {
      ytPlayer.destroy();
      ytPlayer = null;
    }

    function create() {
      ytPlayer = new YT.Player('yt-player-container', {
        width: 320,
        height: 180,
        videoId: videoId,
        playerVars: {
          autoplay: 1,
          controls: 0,
          modestbranding: 1,
          rel: 0
        },
        events: {
          onStateChange: onYTStateChange
        }
      });
    }

    if (ytApiReady) {
      create();
    } else {
      // Wait for API
      const check = setInterval(() => {
        if (ytApiReady) {
          clearInterval(check);
          create();
        }
      }, 100);
    }
  }

  function onYTStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
      isPlaying = true;
      document.body.classList.add('is-playing');
      updatePlayPauseIcon();
    } else if (event.data === YT.PlayerState.PAUSED) {
      isPlaying = false;
      document.body.classList.remove('is-playing');
      updatePlayPauseIcon();
    } else if (event.data === YT.PlayerState.ENDED) {
      isPlaying = false;
      document.body.classList.remove('is-playing');
      updatePlayPauseIcon();
      progressFill.style.width = '100%';
    }
  }

  // ── Controls ──
  function togglePlayPause() {
    if (!currentTrack) return;

    if (currentTrack.platform === 'youtube' && ytPlayer) {
      if (isPlaying) {
        ytPlayer.pauseVideo();
      } else {
        ytPlayer.playVideo();
      }
    } else {
      // For non-YouTube: toggle by showing/hiding iframe (limited control)
      // We can try postMessage but most embeds don't support it
      // Visual toggle only
      isPlaying = !isPlaying;
      if (isPlaying) {
        document.body.classList.add('is-playing');
      } else {
        document.body.classList.remove('is-playing');
      }
      updatePlayPauseIcon();
    }
  }

  function seekRelative(seconds) {
    if (currentTrack?.platform === 'youtube' && ytPlayer && ytPlayer.getCurrentTime) {
      const newTime = ytPlayer.getCurrentTime() + seconds;
      ytPlayer.seekTo(Math.max(0, newTime), true);
    }
  }

  function seekTo(event) {
    if (currentTrack?.platform === 'youtube' && ytPlayer && ytPlayer.getDuration) {
      const rect = event.currentTarget.getBoundingClientRect();
      const pct = (event.clientX - rect.left) / rect.width;
      ytPlayer.seekTo(pct * ytPlayer.getDuration(), true);
    }
  }

  function closePlayer() {
    if (ytPlayer) {
      ytPlayer.destroy();
      ytPlayer = null;
    }
    playerEmbed.innerHTML = '';
    currentTrack = null;
    isPlaying = false;
    document.body.classList.remove('player-active', 'is-playing');
    updatePlayPauseIcon();
    progressFill.style.width = '0%';
    stopProgress();
  }

  function updatePlayPauseIcon() {
    iconPlay.style.display = isPlaying ? 'none' : 'block';
    iconPause.style.display = isPlaying ? 'block' : 'none';
  }

  // ── Progress tracking ──
  function startProgress() {
    stopProgress();
    progressInterval = setInterval(() => {
      if (currentTrack?.platform === 'youtube' && ytPlayer && ytPlayer.getDuration && ytPlayer.getCurrentTime) {
        const duration = ytPlayer.getDuration();
        const current = ytPlayer.getCurrentTime();
        if (duration > 0) {
          progressFill.style.width = (current / duration * 100) + '%';
        }
      }
    }, 500);
  }

  function stopProgress() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }
</script>

</body>
</html>
